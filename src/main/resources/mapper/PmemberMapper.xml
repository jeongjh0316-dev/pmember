<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.pmember.service.PmemberMapper">

    <!-- íšŒì›ê°€ìž… -->
    <insert id="insert" parameterType="com.example.pmember.dto.Pmember">
        INSERT INTO p_member (
        id, pwd, email, birthdate, gender, profile_image
        )
        VALUES (
        #{id},
        #{pw},
        #{email},
        STR_TO_DATE(#{birth}, '%Y-%m-%d'),
        CASE
        WHEN #{gender} IN ('M','F','P') THEN #{gender}
        WHEN #{gender} = 'male'   THEN 'M'
        WHEN #{gender} = 'female' THEN 'F'
        ELSE 'P'
        END,
        #{profileImage}
        )
    </insert>

    <!-- ë¡œê·¸ì¸ ì¡°íšŒ -->
    <select id="findById" parameterType="string"
            resultType="com.example.pmember.dto.Pmember">
        SELECT
        id,
        pwd AS pw,
        email,
        DATE_FORMAT(birthdate, '%Y-%m-%d') AS birth,
        CASE gender
        WHEN 'M' THEN 'male'
        WHEN 'F' THEN 'female'
        ELSE 'private'
        END AS gender,
        profile_image AS profileImage
        FROM p_member
        WHERE id = #{id}
        LIMIT 1
    </select>

    <!-- ì•„ì´ë”” ì¡´ìž¬ ì—¬ë¶€ -->
    <select id="existsById" parameterType="string" resultType="int">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM p_member
        WHERE id = #{id}
    </select>

    <!-- ì´ë©”ì¼ ì¡´ìž¬ ì—¬ë¶€ -->
    <select id="existsByEmail" parameterType="string" resultType="int">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM p_member
        WHERE email = #{email}
    </select>

    <!-- ì•„ì´ë”” ì¹´ìš´íŠ¸ -->
    <select id="countById" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM p_member
        WHERE id = #{id}
    </select>

    <!-- ðŸ”¹ ì•„ì´ë”” ì°¾ê¸° (email + birthdate) -->
    <select id="findIdByEmailAndBirth"
            resultType="string">
        SELECT id
        FROM p_member
        WHERE email = #{email}
        AND birthdate = STR_TO_DATE(#{birth}, '%Y-%m-%d')
        LIMIT 1
    </select>

    <!-- ðŸ”¹ ë¹„ë°€ë²ˆí˜¸ ìž¬ì„¤ì • -->
    <update id="updatePassword">
        UPDATE p_member
        SET pwd = #{pw}
        WHERE id = #{id}
    </update>

    <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ -->
    <update id="updateProfileImage">
        UPDATE p_member
        SET profile_image = #{profileImage}
        WHERE id = #{id}
    </update>

    <!-- ì „ì²´ ì¡°íšŒ -->
    <select id="findFullById" parameterType="string"
            resultType="com.example.pmember.dto.Pmember">
        SELECT
        id,
        pwd AS pw,
        email,
        DATE_FORMAT(birthdate, '%Y-%m-%d') AS birth,
        CASE gender
        WHEN 'M' THEN 'male'
        WHEN 'F' THEN 'female'
        ELSE 'private'
        END AS gender,
        profile_image AS profileImage
        FROM p_member
        WHERE id = #{id}
        LIMIT 1
    </select>

    <!-- íšŒì› ì •ë³´ ìˆ˜ì • (ë¹„ë°€ë²ˆí˜¸ ì œì™¸) -->
    <update id="updateMemberNoPw" parameterType="map">
        UPDATE p_member
        <set>
            id = #{member.id},
            email = #{member.email},
            <if test="member.birth != null and member.birth != ''">
                birthdate = STR_TO_DATE(#{member.birth}, '%Y-%m-%d'),
            </if>
            gender =
            CASE
            WHEN #{member.gender} IN ('M','F','P') THEN #{member.gender}
            WHEN #{member.gender} = 'male'   THEN 'M'
            WHEN #{member.gender} = 'female' THEN 'F'
            ELSE 'P'
            END
        </set>
        WHERE id = #{oldId}
    </update>

    <!-- íšŒì› ì •ë³´ ìˆ˜ì • (ë¹„ë°€ë²ˆí˜¸ í¬í•¨) -->
    <update id="updateMemberWithPw" parameterType="map">
        UPDATE p_member
        <set>
            id = #{member.id},
            pwd = #{member.pw},
            email = #{member.email},
            <if test="member.birth != null and member.birth != ''">
                birthdate = STR_TO_DATE(#{member.birth}, '%Y-%m-%d'),
            </if>
            gender =
            CASE
            WHEN #{member.gender} IN ('M','F','P') THEN #{member.gender}
            WHEN #{member.gender} = 'male'   THEN 'M'
            WHEN #{member.gender} = 'female' THEN 'F'
            ELSE 'P'
            END
        </set>
        WHERE id = #{oldId}
    </update>

</mapper>
